{% extends "layouts/base.html" %}

{% block content %}
<h1>Pedidos</h1>

<!-- Barra de acciones -->
<div class="card">
  <div class="inline">
    <button id="btnNuevo">Nuevo pedido</button>
    <select id="clienteSel" title="Cliente (opcional)">
      <option value="">-- cliente opcional --</option>
    </select>
  </div>
  <p id="topMsg" class="mt-2" style="opacity:.8;"></p>
</div>

<!-- Lista de pedidos -->
<div id="pedidosList" class="card mt-2">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px;">
    <strong>Pedidos del cliente / anónimos</strong>
    <div class="inline">
      <select id="fEstado">
        <option value="">Todos</option>
        <option value="ABIERTO" selected>Abiertos</option>
        <option value="PAGADO">Pagados</option>
        <option value="CANCELADO">Cancelados</option>
      </select>
      <button id="btnRefrescarPedidos" class="ghost">Refrescar</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="stack" id="tablaPedidos">
      <thead>
        <tr>
          <th>ID</th>
          <th>Cliente</th>
          <th>Estado</th>
          <th>Total</th>
          <th>Fecha</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- === Editor de pedido === -->
<div id="editor" class="card mt-2" style="display:none;">
  <p id="pedidoInfo" class="mt-1" style="opacity:.85;"></p>

  <!-- Selección de producto y cantidad -->
  <div class="row mt-2">
    <div>
      <label>Producto</label>
      <select id="prodSel"></select>
    </div>
    <div>
      <label>Cantidad</label>
      <input type="number" id="cantInp" min="1" value="1">
    </div>
  </div>

  <div class="inline mt-2">
    <button id="btnAgregar">Agregar</button>
  </div>

  <!-- Tabla de líneas de pedido -->
  <div class="table-responsive mt-2">
    <table id="tablaLineas" class="stack">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Precio</th>
          <th>Cantidad</th>
          <th>Subtotal</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Total -->
  <h2 class="mt-2">Total: $<span id="total">0.00</span></h2>

  <!-- Método de pago y monto -->
  <div class="row mt-2">
    <div>
      <label>Método de pago</label>
      <select id="metodo">
        <option>EFECTIVO</option>
        <option>TARJETA</option>
        <option>TRANSFERENCIA</option>
      </select>
    </div>
    <div>
      <label>Monto</label>
      <input type="number" id="monto" min="0" step="0.01" value="0">
    </div>
  </div>

  <!-- Botón para registrar pago -->
  <div class="mt-2 inline">
    <button id="btnPagar">Registrar pago</button>
  </div>

  <p id="msg" class="mt-2"></p>

  <!-- Monto pagado -->
  <p id="montoPagado" class="mt-3" style="color: #1d72b8; font-size: 1.6rem; font-weight: bold;"></p>

  <!-- Cambio mostrado destacadamente -->
  <p id="cambio" class="mt-3" style="color: #32CD32; font-size: 1.7rem; font-weight: bold; display: none;"></p>
</div>

<!-- =================== MODAL EDITOR =================== -->
<style>
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(3px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9000;
}

.modal-overlay.active { display: flex; }

.modal-content {
  background: white;
  width: 95%;
  max-width: 900px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 20px rgba(0,0,0,0.4);
  position: relative;
}

.modal-close {
  position: absolute;
  right: 15px;
  top: 12px;
  font-size: 20px;
  background: transparent;
  border: none;
  cursor: pointer;
  opacity: .7;
}
</style>

<div id="modalEditor" class="modal-overlay">
  <div class="modal-content">
      <button class="modal-close" id="btnCerrarModal">✖</button>
      <h2 id="pedidoInfoModal">Pedido</h2>
      <div id="editorModalBody"></div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/pedidos.js') }}"></script>
{% endblock %}
